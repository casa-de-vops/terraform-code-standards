name: $(SourceBranchName)-$(Date:yyyyMMdd)-$(Rev:rrr)

parameters:
  - name: loock_id
    type: string
    default: '00000000-0000-0000-0000-000000000000'

trigger:
  batch: true
  branches:
    include:
      - main
      - develop
  paths:
    include:
      - .azuredevops/tests/environments/*
      - .azuredevops/tests/*.tf
      - .azuredevops/tests/pipeline.yaml

resources:
  repositories:
    - repository: templates
      type: github
      name: 'casa-de-vops/terraform-code-standards'
      ref: 'refs/heads/main'
      endpoint: 'GitHub'
      mapping: '.azuredevops'

stages:
  - template: .azuredevops/stages.unlock.yml@templates
    parameters:
      workload: terraform-pipeline
      working_directory: ./.azuredevops/tests/terraform
      environments: 
      - stage: Dev_Global
        pool: default
        azure_service_connection: terraform
        environment: dev
        ado_environment: nonprod
        backend_service_connection: terraform
        backend_azure_rm_resource_group_name: rg-terraform-ops
        backend_azure_rm_storage_account_name: casadevopsterraform
        backend_azure_rm_container_name: ops-terraform-state      
        backend_azure_rm_key: pipeline-test.dev.tfstate
        lock_id: '${{ parameters.loock_id }}'
